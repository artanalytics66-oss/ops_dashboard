<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ü–æ—Ç–æ–∫–∞ (Fixed)</title>
    
    <!-- 1. –°—Ç–∏–ª–∏ Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React –∏ ReactDOM (CDN Cloudflare - –Ω–∞–¥–µ–∂–Ω–µ–µ) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–¥–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- 4. –ì—Ä–∞—Ñ–∏–∫–∏ Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    
    <style>
        body { background-color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .loading-text { font-size: 1.5rem; color: #64748b; text-align: center; margin-top: 20%; }
        .error-box { background: #fee2e2; color: #b91c1c; padding: 20px; margin: 20px; border-radius: 8px; border: 1px solid #ef4444; font-family: monospace; }
        /* –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è */
        .btn-toggle { transition: all 0.2s; }
        .btn-toggle.active { background-color: #2563eb; color: white; box-shadow: 0 2px 4px rgba(37,99,235,0.2); }
        .btn-toggle.inactive { background-color: white; color: #64748b; border: 1px solid #e2e8f0; }
        .btn-toggle.inactive:hover { background-color: #f1f5f9; }
    </style>
</head>
<body>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="root">
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...<br><span style="font-size: 1rem; opacity: 0.7;">–ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥</span></div>
    </div>

    <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫, –µ—Å–ª–∏ React —É–ø–∞–¥–µ—Ç -->
    <div id="error-display" style="display: none;"></div>

    <!-- –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('root').style.display = 'none';
            const errDiv = document.getElementById('error-display');
            errDiv.style.display = 'block';
            errDiv.className = 'error-box';
            errDiv.innerHTML = `<strong>–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:</strong><br>${message}<br><br><small>${source}:${lineno}</small>`;
        };
    </script>

    <script type="text/babel">
        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        const { useState, useMemo, useEffect } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } = window.Recharts || {};

        if (!window.Recharts) {
            throw new Error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Recharts –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.");
        }

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–ê–ù–ù–´–• ---
        const generateData = () => {
            const clients = ['–û–û–û "–í–µ–∫—Ç–æ—Ä"', '–ò–ü –°–º–∏—Ä–Ω–æ–≤', '–ó–ê–û "–¢–æ—Ä–≥–°–Ω–∞–±"', '–†–µ—Å—Ç–æ—Ä–∞–Ω "–£ –û–∑–µ—Ä–∞"', '–ú–∞–≥–∞–∑–∏–Ω "–ü—Ä–æ–¥—É–∫—Ç—ã"', '–û–û–û "–ê–ª—å—è–Ω—Å"', '–°–µ—Ç—å "–ö–æ–ø–µ–π–∫–∞"'];
            const data = [];
            const statuses = ['Delivered', 'Delivered', 'Delivered', 'OutOfStock', 'NotAssembled', 'NotShipped', 'Returned'];
            
            for (let i = 0; i < 60; i++) {
                data.push({
                    id: `ZAK-${2024001 + i}`,
                    client: clients[Math.floor(Math.random() * clients.length)],
                    status: i < 35 ? 'Delivered' : statuses[Math.floor(Math.random() * statuses.length)],
                    rub: Math.floor(Math.random() * 15000) + 3000,
                    kg: Math.floor(Math.random() * 120) + 10,
                    boxes: Math.floor(Math.random() * 20) + 2,
                    points: 1
                });
            }
            return data;
        };

        const RAW_DATA = generateData();

        // --- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---
        const App = () => {
            const [unit, setUnit] = useState('rub'); // rub, kg, boxes, points
            const [mounted, setMounted] = useState(false);

            useEffect(() => {
                setMounted(true); // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ä–µ–Ω–¥–µ—Ä –∏–¥–µ—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
            }, []);

            // –§–æ—Ä–º–∞—Ç—Ç–µ—Ä
            const formatValue = (val, type = unit) => {
                if (type === 'rub') return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(val);
                if (type === 'kg') return `${val.toLocaleString('ru-RU')} –∫–≥`;
                if (type === 'boxes') return `${val.toLocaleString('ru-RU')} –∫–æ—Ä.`;
                if (type === 'points') return `${val} –¢–¢`;
                return val;
            };

            // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫
            const metrics = useMemo(() => {
                const totalDemand = RAW_DATA.reduce((acc, i) => acc + i[unit], 0);
                const lossOOS = RAW_DATA.filter(i => i.status === 'OutOfStock').reduce((acc, i) => acc + i[unit], 0);
                const lossWhs = RAW_DATA.filter(i => i.status === 'NotAssembled').reduce((acc, i) => acc + i[unit], 0);
                const lossLog = RAW_DATA.filter(i => i.status === 'NotShipped').reduce((acc, i) => acc + i[unit], 0);
                const lossRet = RAW_DATA.filter(i => i.status === 'Returned').reduce((acc, i) => acc + i[unit], 0);
                const fact = RAW_DATA.filter(i => i.status === 'Delivered').reduce((acc, i) => acc + i[unit], 0);

                return { totalDemand, lossOOS, lossWhs, lossLog, lossRet, fact };
            }, [unit]);

            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
            const chartData = [
                { name: '1. –°–ø—Ä–æ—Å', value: metrics.totalDemand, color: '#3b82f6' },
                { name: '–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞', value: metrics.lossOOS, color: '#ef4444' },
                { name: '–ù–µ —Å–æ–±—Ä–∞–Ω–æ', value: metrics.lossWhs, color: '#f97316' },
                { name: '–ù–µ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ', value: metrics.lossLog, color: '#eab308' },
                { name: '–í–æ–∑–≤—Ä–∞—Ç', value: metrics.lossRet, color: '#64748b' },
                { name: '5. –§–∞–∫—Ç', value: metrics.fact, color: '#22c55e' }
            ];

            if (!mounted) return null;

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto pb-20">
                    {/* Header */}
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div>
                            <h1 className="text-3xl font-bold text-slate-800">Ops Finance Flow</h1>
                            <p className="text-slate-500 mt-1">–°—É—Ç–æ—á–Ω—ã–π —Ü–∏–∫–ª –∑–∞–∫–∞–∑–æ–≤</p>
                        </div>
                        <div className="flex bg-white rounded-xl p-1.5 shadow-sm border border-slate-200">
                            {[
                                { id: 'rub', label: '–†—É–±–ª–∏ ‚ÇΩ' },
                                { id: 'kg', label: '–í–µ—Å –ö–ì' },
                                { id: 'boxes', label: '–ú–µ—Å—Ç–∞ üì¶' },
                                { id: 'points', label: '–¢–æ—á–∫–∏ üìç' }
                            ].map((u) => (
                                <button
                                    key={u.id}
                                    onClick={() => setUnit(u.id)}
                                    className={`px-4 py-2 rounded-lg text-sm font-semibold btn-toggle ${unit === u.id ? 'active' : 'inactive'}`}
                                >
                                    {u.label}
                                </button>
                            ))}
                        </div>
                    </header>

                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <MetricCard title="–ü–ª–∞–Ω (–í—á–µ—Ä–∞)" value={metrics.totalDemand} unit={unit} fmt={formatValue} />
                        <MetricCard title="–ü–æ—Ç–µ—Ä–∏ –°–∫–ª–∞–¥–∞" value={metrics.lossWhs + metrics.lossOOS} unit={unit} fmt={formatValue} isLoss />
                        <MetricCard title="–ü–æ—Ç–µ—Ä–∏ –õ–æ–≥–∏—Å—Ç–∏–∫–∏" value={metrics.lossLog + metrics.lossRet} unit={unit} fmt={formatValue} isLoss />
                        <MetricCard title="–§–∞–∫—Ç (–°–µ–≥–æ–¥–Ω—è)" value={metrics.fact} unit={unit} fmt={formatValue} isSuccess />
                    </div>

                    {/* Chart & Tables */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div className="card p-6 lg:col-span-2 min-h-[400px]">
                            <h3 className="text-lg font-bold text-slate-700 mb-4">–í–æ—Ä–æ–Ω–∫–∞ –ø–æ—Ç–µ—Ä—å</h3>
                            <div style={{ width: '100%', height: 300 }}>
                                <ResponsiveContainer>
                                    <BarChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                        <XAxis dataKey="name" tick={{fontSize: 12}} interval={0} />
                                        <YAxis tickFormatter={(v) => v >= 1000 ? (v/1000).toFixed(0) + 'k' : v} />
                                        <Tooltip 
                                            cursor={{fill: '#f1f5f9'}}
                                            content={({ active, payload }) => {
                                                if (active && payload && payload.length) {
                                                    const d = payload[0].payload;
                                                    return (
                                                        <div className="bg-white p-3 shadow-lg rounded border">
                                                            <p className="font-bold">{d.name}</p>
                                                            <p className="text-blue-600 font-bold">{formatValue(d.value)}</p>
                                                        </div>
                                                    );
                                                }
                                                return null;
                                            }}
                                        />
                                        <Bar dataKey="value">
                                            {chartData.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={entry.color} />
                                            ))}
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="flex flex-col gap-4">
                            <div className="card p-5 border-l-4 border-orange-500">
                                <h3 className="font-bold text-slate-700 mb-2">üì¶ –°–∫–ª–∞–¥ (–°–±–æ—Ä–∫–∞)</h3>
                                <KpiRow label="–°–∫–æ—Ä–æ—Å—Ç—å" val="145/—á–∞—Å" status="warn" />
                                <KpiRow label="–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å" val="98.5%" status="ok" />
                                <KpiRow label="–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞" val="2.1%" status="bad" />
                            </div>
                            <div className="card p-5 border-l-4 border-yellow-500">
                                <h3 className="font-bold text-slate-700 mb-2">üöö –õ–æ–≥–∏—Å—Ç–∏–∫–∞</h3>
                                <KpiRow label="–ó–∞–≥—Ä—É–∑–∫–∞" val="92%" status="ok" />
                                <KpiRow label="–°—Ä. –¥—Ä–æ–ø" val="52 –∫–≥" status="ok" />
                                <KpiRow label="–í–æ–∑–≤—Ä–∞—Ç—ã" val="3.4%" status="warn" />
                            </div>
                        </div>
                    </div>

                     {/* Drill Down Table */}
                     <div className="card overflow-hidden">
                        <div className="p-4 border-b bg-gray-50">
                            <h3 className="font-bold text-gray-700">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å–±–æ–µ–≤</h3>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-gray-500 bg-gray-50 border-b">
                                    <tr>
                                        <th className="px-6 py-3">–ó–∞–∫–∞–∑</th>
                                        <th className="px-6 py-3">–°—Ç–∞—Ç—É—Å</th>
                                        <th className="px-6 py-3 text-right">–ü–æ—Ç–µ—Ä–∏</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {RAW_DATA.filter(i => i.status !== 'Delivered').slice(0, 5).map(row => (
                                        <tr key={row.id} className="border-b hover:bg-gray-50">
                                            <td className="px-6 py-3 font-medium">{row.id} <span className="text-gray-400 block text-xs">{row.client}</span></td>
                                            <td className="px-6 py-3"><StatusBadge status={row.status} /></td>
                                            <td className="px-6 py-3 text-right text-red-600 font-mono">{formatValue(row[unit])}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <footer className="mt-12 text-center text-slate-400 text-xs">
                        Ops Finance Flow v2.2 | Powered by React
                    </footer>
                </div>
            );
        };

        // UI Components
        const MetricCard = ({ title, value, unit, fmt, isLoss, isSuccess }) => (
            <div className="card p-5 relative overflow-hidden">
                <p className="text-slate-500 text-sm font-medium">{title}</p>
                <div className={`text-2xl font-bold mt-2 ${isLoss ? 'text-red-600' : isSuccess ? 'text-green-600' : 'text-slate-800'}`}>
                    {isLoss && value > 0 ? '-' : ''}{fmt(value, unit)}
                </div>
            </div>
        );

        const KpiRow = ({ label, val, status }) => {
            const color = status === 'ok' ? 'text-green-700 bg-green-100' : status === 'warn' ? 'text-yellow-700 bg-yellow-100' : 'text-red-700 bg-red-100';
            return (
                <div className="flex justify-between items-center py-2 border-b last:border-0 border-slate-100">
                    <span className="text-sm text-slate-600">{label}</span>
                    <span className={`px-2 py-0.5 rounded text-sm font-bold ${color}`}>{val}</span>
                </div>
            );
        };

        const StatusBadge = ({ status }) => {
            const map = {
                'OutOfStock': { bg: 'bg-red-100', txt: 'text-red-800', lbl: '–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞' },
                'NotAssembled': { bg: 'bg-orange-100', txt: 'text-orange-800', lbl: '–ù–µ —Å–æ–±—Ä–∞–Ω–æ' },
                'NotShipped': { bg: 'bg-yellow-100', txt: 'text-yellow-800', lbl: '–ù–µ –≤–ª–µ–∑–ª–æ' },
                'Returned': { bg: 'bg-slate-100', txt: 'text-slate-800', lbl: '–í–æ–∑–≤—Ä–∞—Ç' }
            };
            const s = map[status] || { bg: 'bg-gray-100', txt: 'text-gray-800', lbl: status };
            return <span className={`px-2 py-1 rounded-full text-xs font-bold ${s.bg} ${s.txt}`}>{s.lbl}</span>;
        };

        // –ó–∞–ø—É—Å–∫
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
