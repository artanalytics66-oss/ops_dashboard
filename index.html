<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ops Finance Flow (Stable)</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React Core (–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–º–∏) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Prop-types (–ù—É–∂–µ–Ω –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    
    <!-- 4. Recharts (–°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è 2.1.9, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –ª–æ–º–∞–µ—Ç UMD) -->
    <script src="https://unpkg.com/recharts@2.1.9/umd/Recharts.js"></script>
    
    <!-- 5. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .btn-toggle { transition: all 0.2s; }
        .btn-toggle.active { background-color: #2563eb; color: white; box-shadow: 0 2px 4px rgba(37,99,235,0.2); }
        .btn-toggle.inactive { background-color: white; color: #64748b; border: 1px solid #e2e8f0; }
        .loading { display: flex; height: 100vh; justify-content: center; align-items: center; font-size: 1.2rem; color: #64748b; }
    </style>
</head>
<body>

    <div id="root">
        <div class="loading">–ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã...</div>
    </div>

    <script type="text/babel">
        // --- –ü–†–û–í–ï–†–ö–ê –ó–ê–ì–†–£–ó–ö–ò –ë–ò–ë–õ–ò–û–¢–ï–ö ---
        if (!window.React || !window.Recharts) {
            document.getElementById('root').innerHTML = '<div style="color:red; text-align:center; margin-top:50px;">–û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ VPN –∏–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</div>';
            throw new Error("Libs not loaded");
        }

        const { useState, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } = Recharts;

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–ê–ù–ù–´–• ---
        const generateData = () => {
            const data = [];
            const statuses = ['Delivered', 'Delivered', 'OutOfStock', 'NotAssembled', 'NotShipped', 'Returned'];
            
            for (let i = 0; i < 50; i++) {
                data.push({
                    id: `ORD-${3000 + i}`,
                    client: `–ö–ª–∏–µ–Ω—Ç ${String.fromCharCode(65 + (i % 5))}`,
                    status: i < 30 ? 'Delivered' : statuses[Math.floor(Math.random() * statuses.length)],
                    rub: Math.floor(Math.random() * 10000) + 2000,
                    kg: Math.floor(Math.random() * 80) + 5,
                    boxes: Math.floor(Math.random() * 15) + 1,
                    points: 1
                });
            }
            return data;
        };
        const RAW_DATA = generateData();

        // --- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---
        const App = () => {
            const [unit, setUnit] = useState('rub'); // rub, kg, boxes, points

            const formatValue = (val, type = unit) => {
                if (type === 'rub') return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(val);
                if (type === 'kg') return `${val} –∫–≥`;
                if (type === 'boxes') return `${val} –∫–æ—Ä.`;
                if (type === 'points') return `${val} –¢–¢`;
                return val;
            };

            const metrics = useMemo(() => {
                const total = RAW_DATA.reduce((acc, i) => acc + i[unit], 0);
                const delivered = RAW_DATA.filter(i => i.status === 'Delivered').reduce((acc, i) => acc + i[unit], 0);
                const lostOOS = RAW_DATA.filter(i => i.status === 'OutOfStock').reduce((acc, i) => acc + i[unit], 0);
                const lostWhs = RAW_DATA.filter(i => i.status === 'NotAssembled').reduce((acc, i) => acc + i[unit], 0);
                const lostLog = RAW_DATA.filter(i => i.status === 'NotShipped').reduce((acc, i) => acc + i[unit], 0);
                const lostRet = RAW_DATA.filter(i => i.status === 'Returned').reduce((acc, i) => acc + i[unit], 0);
                
                return { total, delivered, lostOOS, lostWhs, lostLog, lostRet };
            }, [unit]);

            const chartData = [
                { name: '–°–ø—Ä–æ—Å', value: metrics.total, fill: '#3b82f6' },
                { name: '–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞', value: metrics.lostOOS, fill: '#ef4444' },
                { name: '–ù–µ —Å–æ–±—Ä–∞–Ω–æ', value: metrics.lostWhs, fill: '#f97316' },
                { name: '–ù–µ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ', value: metrics.lostLog, fill: '#eab308' },
                { name: '–í–æ–∑–≤—Ä–∞—Ç', value: metrics.lostRet, fill: '#64748b' },
                { name: '–§–∞–∫—Ç', value: metrics.delivered, fill: '#22c55e' }
            ];

            return (
                <div className="min-h-screen p-4 max-w-7xl mx-auto pb-20">
                    {/* Header */}
                    <header className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-800">Ops Finance Flow</h1>
                            <p className="text-slate-500 text-sm">–°—É—Ç–æ—á–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä v3.0 (Stable)</p>
                        </div>
                        <div className="flex bg-white rounded-lg border p-1">
                            {[
                                { id: 'rub', label: '–†—É–±–ª–∏' },
                                { id: 'kg', label: '–í–µ—Å' },
                                { id: 'boxes', label: '–ú–µ—Å—Ç–∞' },
                                { id: 'points', label: '–¢–æ—á–∫–∏' }
                            ].map(u => (
                                <button
                                    key={u.id}
                                    onClick={() => setUnit(u.id)}
                                    className={`px-3 py-1.5 text-sm rounded-md font-medium btn-toggle ${unit === u.id ? 'active' : 'inactive'}`}
                                >
                                    {u.label}
                                </button>
                            ))}
                        </div>
                    </header>

                    {/* KPI Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <Card title="–ü–ª–∞–Ω (–í—á–µ—Ä–∞)" val={metrics.total} fmt={formatValue} />
                        <Card title="–ü–æ—Ç–µ—Ä–∏ –°–∫–ª–∞–¥–∞" val={metrics.lostWhs + metrics.lostOOS} fmt={formatValue} isBad />
                        <Card title="–ü–æ—Ç–µ—Ä–∏ –õ–æ–≥–∏—Å—Ç–∏–∫–∏" val={metrics.lostLog + metrics.lostRet} fmt={formatValue} isBad />
                        <Card title="–§–∞–∫—Ç (–°–µ–≥–æ–¥–Ω—è)" val={metrics.delivered} fmt={formatValue} isGood />
                    </div>

                    {/* Main Chart */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div className="card p-4 lg:col-span-2 min-h-[350px]">
                            <h3 className="font-bold text-slate-700 mb-4">–í–æ—Ä–æ–Ω–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
                            <ResponsiveContainer width="100%" height={300}>
                                <BarChart data={chartData}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <XAxis dataKey="name" tick={{fontSize: 12}} />
                                    <YAxis tickFormatter={v => v > 999 ? (v/1000).toFixed(0) + 'k' : v} />
                                    <Tooltip 
                                        cursor={{fill: '#f8fafc'}}
                                        content={({ active, payload }) => {
                                            if (active && payload && payload.length) {
                                                return (
                                                    <div className="bg-white p-2 border rounded shadow">
                                                        <span className="font-bold">{payload[0].payload.name}: </span>
                                                        <span className="text-blue-600 font-mono">{formatValue(payload[0].value)}</span>
                                                    </div>
                                                );
                                            }
                                            return null;
                                        }}
                                    />
                                    <Bar dataKey="value" />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>

                        {/* Side Stats */}
                        <div className="flex flex-col gap-4">
                            <div className="card p-4 border-l-4 border-orange-400">
                                <h3 className="font-bold text-slate-700 mb-2">üì¶ –°–∫–ª–∞–¥</h3>
                                <div className="space-y-3">
                                    <Row label="–°–∫–æ—Ä–æ—Å—Ç—å" val="145/—á–∞—Å" />
                                    <Row label="–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å" val="98%" color="text-green-600" />
                                    <Row label="–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞" val="2.4%" color="text-red-600" />
                                </div>
                            </div>
                            <div className="card p-4 border-l-4 border-yellow-400">
                                <h3 className="font-bold text-slate-700 mb-2">üöö –õ–æ–≥–∏—Å—Ç–∏–∫–∞</h3>
                                <div className="space-y-3">
                                    <Row label="–ó–∞–≥—Ä—É–∑–∫–∞" val="92%" />
                                    <Row label="–°—Ä–µ–¥–Ω–∏–π –¥—Ä–æ–ø" val="52 –∫–≥" />
                                    <Row label="–í–æ–∑–≤—Ä–∞—Ç—ã" val="3.1%" color="text-red-600" />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Table */}
                    <div className="card overflow-hidden">
                        <div className="px-6 py-4 border-b bg-gray-50 font-bold text-slate-700">–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-gray-500 border-b bg-white">
                                    <tr>
                                        <th className="px-6 py-3">ID</th>
                                        <th className="px-6 py-3">–°—Ç–∞—Ç—É—Å</th>
                                        <th className="px-6 py-3 text-right">–ü–æ—Ç–µ—Ä—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {RAW_DATA.filter(x => x.status !== 'Delivered').slice(0,5).map(r => (
                                        <tr key={r.id} className="border-b hover:bg-gray-50">
                                            <td className="px-6 py-3 font-mono">{r.id}</td>
                                            <td className="px-6 py-3">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                    r.status==='OutOfStock' ? 'bg-red-100 text-red-800' :
                                                    r.status==='NotAssembled' ? 'bg-orange-100 text-orange-800' :
                                                    'bg-yellow-100 text-yellow-800'
                                                }`}>{r.status}</span>
                                            </td>
                                            <td className="px-6 py-3 text-right font-mono text-red-600">{formatValue(r[unit])}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div className="text-center text-gray-400 mt-8 text-xs">v3.0 Stable Build</div>
                </div>
            );
        };

        const Card = ({ title, val, fmt, isBad, isGood }) => (
            <div className="card p-4">
                <div className="text-gray-500 text-xs uppercase font-bold mb-1">{title}</div>
                <div className={`text-xl font-bold ${isBad ? 'text-red-600' : isGood ? 'text-green-600' : 'text-slate-800'}`}>
                    {fmt(val)}
                </div>
            </div>
        );

        const Row = ({ label, val, color = 'text-slate-800' }) => (
            <div className="flex justify-between text-sm">
                <span className="text-slate-500">{label}</span>
                <span className={`font-bold ${color}`}>{val}</span>
            </div>
        );

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

