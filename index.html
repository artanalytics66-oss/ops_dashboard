<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ü–æ—Ç–æ–∫–∞</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts for Charts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .btn-toggle { transition: all 0.2s; }
        .btn-toggle.active { background-color: #2563eb; color: white; box-shadow: 0 2px 4px rgba(37,99,235,0.2); }
        .btn-toggle.inactive { background-color: white; color: #64748b; border: 1px solid #e2e8f0; }
        .btn-toggle.inactive:hover { background-color: #f1f5f9; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, ReferenceLine } = Recharts;

        // --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–†—É—Å—Å–∫–∏–π —è–∑—ã–∫) ---
        const generateData = () => {
            const clients = ['–û–û–û "–í–µ–∫—Ç–æ—Ä"', '–ò–ü –°–º–∏—Ä–Ω–æ–≤', '–ó–ê–û "–¢–æ—Ä–≥–°–Ω–∞–±"', '–†–µ—Å—Ç–æ—Ä–∞–Ω "–£ –û–∑–µ—Ä–∞"', '–ú–∞–≥–∞–∑–∏–Ω "–ü—Ä–æ–¥—É–∫—Ç—ã"', '–û–û–û "–ê–ª—å—è–Ω—Å"', '–°–µ—Ç—å "–ö–æ–ø–µ–π–∫–∞"'];
            const data = [];
            // –°—Ç–∞—Ç—É—Å—ã: Created (–°–ø—Ä–æ—Å), OutOfStock (–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞), NotAssembled (–ù–µ —Å–æ–±—Ä–∞–Ω–æ), NotShipped (–ù–µ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ), Returned (–í–æ–∑–≤—Ä–∞—Ç), Delivered (–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ)
            const statuses = ['Delivered', 'Delivered', 'Delivered', 'OutOfStock', 'NotAssembled', 'NotShipped', 'Returned'];

            for (let i = 0; i < 60; i++) {
                data.push({
                    id: `ZAK-${2024001 + i}`,
                    client: clients[Math.floor(Math.random() * clients.length)],
                    status: i < 40 ? 'Delivered' : statuses[Math.floor(Math.random() * statuses.length)],
                    rub: Math.floor(Math.random() * 15000) + 3000,
                    kg: Math.floor(Math.random() * 120) + 10,
                    boxes: Math.floor(Math.random() * 20) + 2,
                    points: 1
                });
            }
            return data;
        };

        const RAW_DATA = generateData();

        const App = () => {
            const [unit, setUnit] = useState('rub'); // rub, kg, boxes, points

            // --- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ---
            const formatValue = (val, type = unit) => {
                if (type === 'rub') return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(val);
                if (type === 'kg') return `${val.toLocaleString('ru-RU')} –∫–≥`;
                if (type === 'boxes') return `${val.toLocaleString('ru-RU')} –∫–æ—Ä.`;
                if (type === 'points') return `${val} –¢–¢`;
                return val;
            };

            // --- –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ---
            const metrics = useMemo(() => {
                const totalDemand = RAW_DATA.reduce((acc, i) => acc + i[unit], 0);

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ—Ç–µ—Ä—å
                const lossOOS = RAW_DATA.filter(i => i.status === 'OutOfStock').reduce((acc, i) => acc + i[unit], 0);
                const lossWhs = RAW_DATA.filter(i => i.status === 'NotAssembled').reduce((acc, i) => acc + i[unit], 0);
                const lossLog = RAW_DATA.filter(i => i.status === 'NotShipped').reduce((acc, i) => acc + i[unit], 0);
                const lossRet = RAW_DATA.filter(i => i.status === 'Returned').reduce((acc, i) => acc + i[unit], 0);
                const fact = RAW_DATA.filter(i => i.status === 'Delivered').reduce((acc, i) => acc + i[unit], 0);

                return { totalDemand, lossOOS, lossWhs, lossLog, lossRet, fact };
            }, [unit]);

            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞-–º–æ—Å—Ç–∞
            const chartData = [
                { name: '–°–ø—Ä–æ—Å (–í—á–µ—Ä–∞)', value: metrics.totalDemand, type: 'start', color: '#3b82f6' },
                { name: '–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞', value: metrics.lossOOS, type: 'loss', color: '#ef4444' },
                { name: '–ù–µ —Å–æ–±—Ä–∞–Ω–æ', value: metrics.lossWhs, type: 'loss', color: '#f97316' },
                { name: '–ù–µ –≤–ª–µ–∑–ª–æ', value: metrics.lossLog, type: 'loss', color: '#eab308' },
                { name: '–í–æ–∑–≤—Ä–∞—Ç', value: metrics.lossRet, type: 'loss', color: '#64748b' },
                { name: '–§–∞–∫—Ç (–°–µ–≥–æ–¥–Ω—è)', value: metrics.fact, type: 'end', color: '#22c55e' }
            ];

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto">
                    {/* –®–∞–ø–∫–∞ */}
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div>
                            <h1 className="text-3xl font-bold text-slate-800">–ú–æ–Ω–∏—Ç–æ—Ä –í—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ó–∞–∫–∞–∑–æ–≤</h1>
                            <p className="text-slate-500 mt-1">–ê–Ω–∞–ª–∏–∑ —Å—É—Ç–æ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞: –í—á–µ—Ä–∞ (–ó–∞–∫–∞–∑) ‚Üí –°–µ–≥–æ–¥–Ω—è (–î–æ—Å—Ç–∞–≤–∫–∞)</p>
                        </div>

                        {/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –µ–¥–∏–Ω–∏—Ü */}
                        <div className="flex bg-white rounded-xl p-1.5 shadow-sm border border-slate-200">
                            {[
                                { id: 'rub', label: '–†—É–±–ª–∏ ‚ÇΩ' },
                                { id: 'kg', label: '–í–µ—Å –ö–ì' },
                                { id: 'boxes', label: '–ú–µ—Å—Ç–∞ üì¶' },
                                { id: 'points', label: '–¢–æ—á–∫–∏ üìç' }
                            ].map((u) => (
                                <button
                                    key={u.id}
                                    onClick={() => setUnit(u.id)}
                                    className={`px-4 py-2 rounded-lg text-sm font-semibold btn-toggle ${unit === u.id ? 'active' : 'inactive'}`}
                                >
                                    {u.label}
                                </button>
                            ))}
                        </div>
                    </header>

                    {/* –í–µ—Ä—Ö–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–°–≤–æ–¥–∫–∞) */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <MetricCard title="–ü–ª–∞–Ω (–°–ø—Ä–æ—Å)" value={metrics.totalDemand} unit={unit} fmt={formatValue} icon="üìã" />
                        <MetricCard title="–ü–æ—Ç–µ—Ä–∏ –°–∫–ª–∞–¥–∞" value={metrics.lossWhs + metrics.lossOOS} unit={unit} fmt={formatValue} isLoss />
                        <MetricCard title="–ü–æ—Ç–µ—Ä–∏ –õ–æ–≥–∏—Å—Ç–∏–∫–∏" value={metrics.lossLog + metrics.lossRet} unit={unit} fmt={formatValue} isLoss />
                        <MetricCard title="–§–∞–∫—Ç (–í –∫–∞—Å—Å–µ)" value={metrics.fact} unit={unit} fmt={formatValue} isSuccess />
                    </div>

                    {/* –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

                        {/* –ì—Ä–∞—Ñ–∏–∫ –í–æ–¥–æ–ø–∞–¥ */}
                        <div className="card p-6 lg:col-span-2">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-lg font-bold text-slate-700">–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω –ø–æ—Ç–µ—Ä—å (–í–æ—Ä–æ–Ω–∫–∞)</h3>
                                <span className="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">–û–±–Ω–æ–≤–ª–µ–Ω–æ: 18:00</span>
                            </div>
                            <div className="h-80 w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                        <XAxis dataKey="name" tick={{fontSize: 12, fill: '#64748b'}} interval={0} />
                                        <YAxis tickFormatter={(val) => val >= 1000 ? `${(val/1000).toFixed(0)}k` : val} tick={{fontSize: 12, fill: '#64748b'}} />
                                        <Tooltip 
                                            cursor={{fill: '#f1f5f9'}}
                                            content={({ active, payload }) => {
                                                if (active && payload && payload.length) {
                                                    const data = payload[0].payload;
                                                    return (
                                                        <div className="bg-white p-3 shadow-lg rounded-lg border border-slate-100">
                                                            <p className="font-bold text-slate-800">{data.name}</p>
                                                            <p className="text-blue-600 font-medium text-lg">
                                                                {data.type === 'loss' ? '-' : ''}{formatValue(data.value)}
                                                            </p>
                                                        </div>
                                                    );
                                                }
                                                return null;
                                            }}
                                        />
                                        <Bar dataKey="value" radius={[6, 6, 0, 0]}>
                                            {chartData.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={entry.color} />
                                            ))}
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* KPI –ü–∞–Ω–µ–ª–∏ */}
                        <div className="flex flex-col gap-4">
                            {/* –°–∫–ª–∞–¥ */}
                            <div className="card p-5 border-l-4 border-orange-500">
                                <div className="flex items-center gap-2 mb-4">
                                    <span className="bg-orange-100 p-1.5 rounded text-orange-600 text-xl">üì¶</span>
                                    <h3 className="font-bold text-slate-700">–°–∫–ª–∞–¥ (–°–±–æ—Ä–∫–∞)</h3>
                                </div>
                                <div className="space-y-4">
                                    <KpiRow label="–°–∫–æ—Ä–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏" val="145 –∫–æ—Ä/—á–∞—Å" sub="–ü–ª–∞–Ω: 150" status="warn" />
                                    <KpiRow label="–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å (Cut-off)" val="98.5%" sub="–ö 07:00 —É—Ç—Ä–∞" status="ok" />
                                    <KpiRow label="–¢–æ—á–Ω–æ—Å—Ç—å (–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞)" val="2.1%" sub="–û—à–∏–±–∫–∏ —Å—Ç–æ–∫–∞" status="bad" />
                                </div>
                            </div>

                            {/* –õ–æ–≥–∏—Å—Ç–∏–∫–∞ */}
                            <div className="card p-5 border-l-4 border-yellow-500">
                                <div className="flex items-center gap-2 mb-4">
                                    <span className="bg-yellow-100 p-1.5 rounded text-yellow-600 text-xl">üöö</span>
                                    <h3 className="font-bold text-slate-700">–õ–æ–≥–∏—Å—Ç–∏–∫–∞</h3>
                                </div>
                                <div className="space-y-4">
                                    <KpiRow label="–ó–∞–≥—Ä—É–∑–∫–∞ (–û–±—ä–µ–º)" val="92%" sub="–ö—É–∑–æ–≤ –ø–æ–ª–æ–Ω" status="ok" />
                                    <KpiRow label="–°—Ä–µ–¥–Ω–∏–π –¥—Ä–æ–ø" val="52 –∫–≥" sub="–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å" status="ok" />
                                    <KpiRow label="–í–æ–∑–≤—Ä–∞—Ç—ã" val="3.4%" sub="–û—Ç–∫–∞–∑ –Ω–∞ –∞–¥—Ä–µ—Å–µ" status="warn" />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è (–¢–∞–±–ª–∏—Ü–∞) */}
                    <div className="card overflow-hidden">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 className="font-bold text-slate-700">–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–∫–∞–∑—ã (–¢–æ–ø-5)</h3>
                            <button className="text-blue-600 text-sm font-medium hover:underline">–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç CSV</button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-slate-600">
                                <thead className="bg-slate-50 text-slate-500 uppercase font-bold text-xs">
                                    <tr>
                                        <th className="px-6 py-3">‚Ññ –ó–∞–∫–∞–∑–∞</th>
                                        <th className="px-6 py-3">–ö–ª–∏–µ–Ω—Ç</th>
                                        <th className="px-6 py-3">–°—Ç–∞—Ç—É—Å –ø—Ä–æ–±–ª–µ–º—ã</th>
                                        <th className="px-6 py-3 text-right">–ü–æ—Ç–µ—Ä–∏ (‚ÇΩ)</th>
                                        <th className="px-6 py-3 text-right">–í–µ—Å</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {RAW_DATA.filter(i => i.status !== 'Delivered').slice(0, 5).map(row => (
                                        <tr key={row.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="px-6 py-4 font-medium text-slate-900">{row.id}</td>
                                            <td className="px-6 py-4">{row.client}</td>
                                            <td className="px-6 py-4">
                                                <StatusBadge status={row.status} />
                                            </td>
                                            <td className="px-6 py-4 text-right font-mono text-red-600">{formatValue(row.rub, 'rub')}</td>
                                            <td className="px-6 py-4 text-right font-mono">{formatValue(row.kg, 'kg')}</td>
                                        </tr>
                                    ))}
                                    {RAW_DATA.filter(i => i.status !== 'Delivered').length === 0 && (
                                        <tr><td colSpan="5" className="text-center py-6 text-slate-400">–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ üéâ</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <footer className="mt-8 text-center text-slate-400 text-xs pb-8">
                        –°–∏—Å—Ç–µ–º–∞ Ops Finance Flow | –í–µ—Ä—Å–∏—è 2.1 RU | –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: {new Date().toLocaleDateString()}
                    </footer>
                </div>
            );
        };

        // --- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI ---

        const MetricCard = ({ title, value, unit, fmt, isLoss, isSuccess, icon }) => (
            <div className="card p-5 flex flex-col justify-between h-full relative overflow-hidden">
                <div className="flex justify-between items-start z-10">
                    <span className="text-slate-500 text-sm font-medium">{title}</span>
                    {icon && <span className="text-xl opacity-50">{icon}</span>}
                </div>
                <div className={`text-2xl font-bold mt-2 z-10 ${isLoss ? 'text-red-600' : isSuccess ? 'text-green-600' : 'text-slate-800'}`}>
                    {isLoss && value > 0 ? '-' : ''}{fmt(value, unit)}
                </div>
                {isLoss && <div className="absolute right-0 bottom-0 h-16 w-16 bg-red-50 rounded-tl-full opacity-50" />}
                {isSuccess && <div className="absolute right-0 bottom-0 h-16 w-16 bg-green-50 rounded-tl-full opacity-50" />}
            </div>
        );

        const KpiRow = ({ label, val, sub, status }) => {
            const styles = {
                ok: 'text-green-700 bg-green-100',
                warn: 'text-yellow-700 bg-yellow-100',
                bad: 'text-red-700 bg-red-100'
            };
            return (
                <div className="flex justify-between items-center py-1">
                    <div>
                        <div className="text-sm font-semibold text-slate-700">{label}</div>
                        <div className="text-xs text-slate-400">{sub}</div>
                    </div>
                    <div className={`px-2.5 py-1 rounded-lg text-sm font-bold ${styles[status]}`}>
                        {val}
                    </div>
                </div>
            );
        };

        const StatusBadge = ({ status }) => {
            const map = {
                'OutOfStock': { label: '–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞', style: 'bg-red-100 text-red-700 border-red-200' },
                'NotAssembled': { label: '–ù–µ —Å–æ–±—Ä–∞–Ω–æ', style: 'bg-orange-100 text-orange-700 border-orange-200' },
                'NotShipped': { label: '–ù–µ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ', style: 'bg-yellow-100 text-yellow-700 border-yellow-200' },
                'Returned': { label: '–í–æ–∑–≤—Ä–∞—Ç', style: 'bg-slate-100 text-slate-600 border-slate-200' }
            };
            const s = map[status] || { label: status, style: 'bg-gray-100' };
            return (
                <span className={`px-3 py-1 rounded-full text-xs font-bold border ${s.style}`}>
                    {s.label}
                </span>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
