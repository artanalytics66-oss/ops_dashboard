<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä –ò—Å–ø–æ–ª–Ω–µ–Ω–∏—è –ó–∞–∫–∞–∑–æ–≤ (Excel Edition)</title>
    <!-- SheetJS –¥–ª—è —á—Ç–µ–Ω–∏—è Excel –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; --muted: #64748b; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞–º–∏ */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid #e2e8f0; color: var(--text); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        input[type="file"] { display: none; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ KPI */
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kpi-label { font-size: 13px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
        .kpi-value { font-size: 28px; font-weight: 700; margin-top: 5px; }
        .text-red { color: #dc2626; } .text-green { color: #16a34a; }

        /* –ì—Ä–∞—Ñ–∏–∫ */
        .chart-wrap { height: 250px; display: flex; align-items: flex-end; gap: 10px; padding-top: 30px; }
        .bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; }
        .bar { width: 100%; border-radius: 6px 6px 0 0; min-height: 4px; transition: height 0.5s; position: relative; }
        .bar-val { position: absolute; top: -25px; font-weight: 700; font-size: 13px; }
        .bar-lbl { font-size: 12px; color: var(--muted); margin-top: 8px; text-align: center; }
        /* –¶–≤–µ—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–∞ */
        .c-blue { background: #3b82f6; } .c-red { background: #ef4444; } .c-orange { background: #f97316; } 
        .c-yellow { background: #eab308; } .c-gray { background: #94a3b8; } .c-green { background: #22c55e; }

        /* –¢–∞–±–ª–∏—Ü–∞ */
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        th { text-align: left; padding: 10px; color: var(--muted); border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .b-red { background: #fee2e2; color: #991b1b; } .b-orange { background: #ffedd5; color: #9a3412; }
        .b-yellow { background: #fef9c3; color: #854d0e; }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å */
        .toggles { background: #f1f5f9; padding: 4px; border-radius: 8px; display: inline-flex; }
        .tog-btn { padding: 6px 12px; border: none; background: transparent; cursor: pointer; border-radius: 6px; color: var(--muted); font-weight: 600; }
        .tog-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h1 style="margin:0;">–ú–æ–Ω–∏—Ç–æ—Ä –ò—Å–ø–æ–ª–Ω–µ–Ω–∏—è</h1>
            <div style="color: var(--muted); font-size: 14px;">–ê–Ω–∞–ª–∏–∑ —Ñ–∞–∫—Ç–∞: –ü–ª–∞–Ω ‚Üí –§–∞–∫—Ç</div>
        </div>
        <div class="toggles">
            <button class="tog-btn active" onclick="setUnit('rub')">–†—É–±–ª–∏ ‚ÇΩ</button>
            <button class="tog-btn" onclick="setUnit('kg')">–í–µ—Å –ö–ì</button>
            <button class="tog-btn" onclick="setUnit('box')">–ö–æ—Ä–æ–±–∞</button>
        </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏ -->
    <div class="controls">
        <label class="btn btn-primary">
            üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel/CSV
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" onchange="handleFile(this)">
        </label>
        <button class="btn btn-outline" onclick="downloadTemplate()">‚¨á –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω</button>
        <span style="font-size: 13px; color: var(--muted); margin-left: auto;" id="fileStatus">–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</span>
    </div>

    <!-- KPI –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥ -->
    <div class="grid-4">
        <div class="card">
            <div class="kpi-label">–ü–ª–∞–Ω (–°–ø—Ä–æ—Å)</div>
            <div class="kpi-value" id="kpi-plan">0</div>
        </div>
        <div class="card">
            <div class="kpi-label">–ü–æ—Ç–µ—Ä–∏ –°–∫–ª–∞–¥–∞</div>
            <div class="kpi-value text-red" id="kpi-loss-wh">0</div>
        </div>
        <div class="card">
            <div class="kpi-label">–ü–æ—Ç–µ—Ä–∏ –õ–æ–≥–∏—Å—Ç–∏–∫–∏</div>
            <div class="kpi-value text-red" id="kpi-loss-log">0</div>
        </div>
        <div class="card">
            <div class="kpi-label">–§–∞–∫—Ç</div>
            <div class="kpi-value text-green" id="kpi-fact">0</div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- –ì—Ä–∞—Ñ–∏–∫ -->
        <div class="card">
            <h3 style="margin:0 0 10px 0; color:var(--text);">–í–æ—Ä–æ–Ω–∫–∞ –ü–æ—Ç–µ—Ä—å (Waterfall)</h3>
            <div class="chart-wrap" id="chart"></div>
        </div>

        <!-- –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ) -->
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div class="card" style="border-left: 4px solid #f97316;">
                <div class="kpi-label" style="margin-bottom: 10px;">üì¶ –°–ö–õ–ê–î</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>–°–∫–æ—Ä–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏</span>
                    <strong id="op-speed">0 –∫–æ—Ä/—á–∞—Å</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞ (OOS)</span>
                    <strong class="text-red" id="op-oos">0%</strong>
                </div>
            </div>
            <div class="card" style="border-left: 4px solid #eab308;">
                <div class="kpi-label" style="margin-bottom: 10px;">üöö –õ–û–ì–ò–°–¢–ò–ö–ê</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ</span>
                    <strong id="op-load">0%</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>–°—Ä–µ–¥–Ω–∏–π –¥—Ä–æ–ø</span>
                    <strong id="op-drop">0 –∫–≥</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div class="card">
        <h3 style="margin:0; color:var(--text);">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å–±–æ–µ–≤</h3>
        <table>
            <thead><tr><th>–ó–∞–∫–∞–∑</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th style="text-align:right">–ü–æ—Ç–µ—Ä—è</th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script>
    // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –î–ê–ù–ù–´–ï ===
    let DATA = []; // –û—Å–Ω–æ–≤–Ω–æ–π –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö
    let UNIT = 'rub';
    const PARAMS = {
        workHours: 10,     // –ß–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã —Å–∫–ª–∞–¥–∞ –≤ —Å–º–µ–Ω—É (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏)
        fleetCapacity: 5000 // –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ–ø–∞—Ä–∫–∞ –≤ –∫–≥ (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏)
    };

    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö
    function initDemo() {
        DATA = Array.from({length: 50}, (_, i) => ({
            'ID –ó–∞–∫–∞–∑–∞': `ORD-${5000+i}`,
            '–ö–ª–∏–µ–Ω—Ç': `–ö–ª–∏–µ–Ω—Ç ${['–ê','–ë','–í'][i%3]}`,
            '–°—Ç–∞—Ç—É—Å': i<35 ? '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ' : ['–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞','–ù–µ —Å–æ–±—Ä–∞–Ω–æ','–ù–µ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ','–í–æ–∑–≤—Ä–∞—Ç'][i%4],
            '–†—É–±–ª–∏': Math.floor(Math.random()*10000)+2000,
            '–í–µ—Å': Math.floor(Math.random()*80)+5,
            '–ö–æ—Ä–æ–±–∞': Math.floor(Math.random()*10)+1
        }));
        render();
    }

    // 2. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (–û—Ç—Ä–∏—Å–æ–≤–∫–∞)
    function render() {
        // –ê–≥—Ä–µ–≥–∞—Ü–∏—è
        const sum = (fn) => DATA.filter(fn).reduce((acc, r) => acc + (parseFloat(r[getColName()]) || 0), 0);
        
        const plan = sum(() => true);
        const lossOOS = sum(r => r['–°—Ç–∞—Ç—É—Å'] === '–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞');
        const lossWhs = sum(r => r['–°—Ç–∞—Ç—É—Å'] === '–ù–µ —Å–æ–±—Ä–∞–Ω–æ');
        const lossLog = sum(r => r['–°—Ç–∞—Ç—É—Å'] === '–ù–µ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ');
        const lossRet = sum(r => r['–°—Ç–∞—Ç—É—Å'] === '–í–æ–∑–≤—Ä–∞—Ç');
        const fact = sum(r => r['–°—Ç–∞—Ç—É—Å'] === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ');

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ KPI
        document.getElementById('kpi-plan').innerText = fmt(plan);
        document.getElementById('kpi-loss-wh').innerText = fmt(lossOOS + lossWhs);
        document.getElementById('kpi-loss-log').innerText = fmt(lossLog + lossRet);
        document.getElementById('kpi-fact').innerText = fmt(fact);

        // –†–∞—Å—á–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ (–ß–ï–°–¢–ù–´–ô –†–ê–°–ß–ï–¢)
        // –°–∫–æ—Ä–æ—Å—Ç—å = –í—Å–µ–≥–æ –∫–æ—Ä–æ–±–æ–∫ / –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã
        const totalBoxes = DATA.reduce((acc, r) => acc + (r['–ö–æ—Ä–æ–±–∞']||0), 0);
        const speed = Math.round(totalBoxes / PARAMS.workHours);
        document.getElementById('op-speed').innerText = `${speed} –∫–æ—Ä/—á–∞—Å`;

        // OOS %
        const oosCount = DATA.filter(r => r['–°—Ç–∞—Ç—É—Å'] === '–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞').length;
        const oosRate = ((oosCount / DATA.length) * 100).toFixed(1);
        document.getElementById('op-oos').innerText = `${oosRate}%`;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ (–°—É–º–º–∞ –≤–µ—Å–∞ —Ñ–∞–∫—Ç–∞ / –õ–∏–º–∏—Ç –ø–∞—Ä–∫–∞)
        const factWeight = DATA.filter(r => ['–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ','–ù–µ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ'].includes(r['–°—Ç–∞—Ç—É—Å'])).reduce((acc,r) => acc + (r['–í–µ—Å']||0), 0);
        const loadRate = Math.min(100, Math.round((factWeight / PARAMS.fleetCapacity) * 100));
        document.getElementById('op-load').innerText = `${loadRate}%`;

        // –°—Ä–µ–¥–Ω–∏–π –¥—Ä–æ–ø (–í–µ—Å —Ñ–∞–∫—Ç–∞ / –ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤ —Ñ–∞–∫—Ç–∞)
        const factOrders = DATA.filter(r => r['–°—Ç–∞—Ç—É—Å'] === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ').length;
        const avgDrop = factOrders ? Math.round(factWeight / factOrders) : 0;
        document.getElementById('op-drop').innerText = `${avgDrop} –∫–≥`;


        // –ì—Ä–∞—Ñ–∏–∫
        const max = plan || 1;
        const bars = [
            {l:'–ü–ª–∞–Ω', v:plan, c:'c-blue'}, {l:'–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞', v:lossOOS, c:'c-red'},
            {l:'–ù–µ —Å–æ–±—Ä–∞–Ω–æ', v:lossWhs, c:'c-orange'}, {l:'–ù–µ –æ—Ç–≥—Ä.', v:lossLog, c:'c-yellow'},
            {l:'–í–æ–∑–≤—Ä–∞—Ç', v:lossRet, c:'c-gray'}, {l:'–§–∞–∫—Ç', v:fact, c:'c-green'}
        ];
        
        document.getElementById('chart').innerHTML = bars.map(b => {
            const h = Math.max(2, (b.v / max) * 100);
            return `
            <div class="bar-col">
                <div class="bar-val">${fmtCompact(b.v)}</div>
                <div class="bar ${b.c}" style="height:${h}%"></div>
                <div class="bar-lbl">${b.l}</div>
            </div>`;
        }).join('');

        // –¢–∞–±–ª–∏—Ü–∞ (–¢–æ–ø 5 –ø—Ä–æ–±–ª–µ–º)
        const problems = DATA.filter(r => r['–°—Ç–∞—Ç—É—Å'] !== '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ').slice(0, 5);
        document.getElementById('table-body').innerHTML = problems.map(r => {
            let cls = r['–°—Ç–∞—Ç—É—Å'] === '–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞' ? 'b-red' : r['–°—Ç–∞—Ç—É—Å'] === '–ù–µ —Å–æ–±—Ä–∞–Ω–æ' ? 'b-orange' : 'b-yellow';
            return `
            <tr>
                <td>${r['ID –ó–∞–∫–∞–∑–∞']}</td>
                <td>${r['–ö–ª–∏–µ–Ω—Ç']}</td>
                <td><span class="badge ${cls}">${r['–°—Ç–∞—Ç—É—Å']}</span></td>
                <td style="text-align:right; font-weight:bold">${fmt(r[getColName()])}</td>
            </tr>`;
        }).join('') || '<tr><td colspan="4" style="text-align:center; padding:20px">–ù–µ—Ç —Å–±–æ–µ–≤</td></tr>';
    }

    // 3. –£—Ç–∏–ª–∏—Ç—ã
    function getColName() {
        if(UNIT==='rub') return '–†—É–±–ª–∏';
        if(UNIT==='kg') return '–í–µ—Å';
        return '–ö–æ—Ä–æ–±–∞';
    }
    function fmt(v) {
        if(UNIT==='rub') return new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0}).format(v);
        if(UNIT==='kg') return v + ' –∫–≥';
        return v + ' —à—Ç';
    }
    function fmtCompact(v) {
        if(UNIT==='rub') return (v/1000).toFixed(0) + 'k';
        return v;
    }
    function setUnit(u) {
        UNIT = u;
        document.querySelectorAll('.tog-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        render();
    }

    // 4. Excel –õ–æ–≥–∏–∫–∞
    function downloadTemplate() {
        const wb = XLSX.utils.book_new();
        const ws_data = [
            ['ID –ó–∞–∫–∞–∑–∞', '–ö–ª–∏–µ–Ω—Ç', '–°—Ç–∞—Ç—É—Å', '–†—É–±–ª–∏', '–í–µ—Å', '–ö–æ—Ä–æ–±–∞'], // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            ['ORD-001', '–û–û–û –†–æ–º–∞—à–∫–∞', '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ', 5000, 20, 2],
            ['ORD-002', '–ò–ü –ò–≤–∞–Ω–æ–≤', '–ù–µ—Ç —Ç–æ–≤–∞—Ä–∞', 3000, 10, 1],
            ['ORD-003', '–ó–ê–û –í–µ–∫—Ç–æ—Ä', '–ù–µ —Å–æ–±—Ä–∞–Ω–æ', 15000, 100, 10]
        ];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "–®–∞–±–ª–æ–Ω");
        XLSX.writeFile(wb, "Template_Ops_Dashboard.xlsx");
    }

    function handleFile(input) {
        const file = input.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–æ–Ω–æ–∫
            if(!jsonData[0]['ID –ó–∞–∫–∞–∑–∞'] || !jsonData[0]['–°—Ç–∞—Ç—É—Å']) {
                alert('–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –°–∫–∞—á–∞–π—Ç–µ —à–∞–±–ª–æ–Ω!');
                return;
            }

            DATA = jsonData;
            document.getElementById('fileStatus').innerText = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${file.name} (${DATA.length} —Å—Ç—Ä–æ–∫)`;
            document.getElementById('fileStatus').style.color = '#16a34a';
            render();
        };
        reader.readAsArrayBuffer(file);
    }

    // –ó–∞–ø—É—Å–∫
    initDemo();
</script>

</body>
</html>
